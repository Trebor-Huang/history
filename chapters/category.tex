\chapter{范畴语义}

本章介绍类型论的范畴语义. 注意我们研究类型论的
语义时, 类型论是被研究的数学对象, 而不是正在使用的数学语言.
此时使用的语言可以自由选择, 例如自然语言、集合论甚至类型论本身.
这个外部的语言称作\textbf{元语言}, 而被研究的类型论语言就直接
称作“语言”. 切忌混淆元语言中的概念与语言内的概念. 另一个
容易混淆的事情, 在于语义中的许多概念都是为了与语法中的事物
相对应, 因此二者会用相近的名称与记号, 但是它们也不应当混同.

类型论模型的一个极重要的特征就是其(广义的)代数性. 何为代数性?
最狭义来说, 一个代数结构就是某集合上配备一些运算, 并且满足
形如 \(\forall x_1, x_2, \dots, M = N\) 的公理. 例如
群、环、\(\Bbbk\)-向量空间等等. 代数结构通常满足一系列性质,
例如同态定理, 三条同构定理等. 对代数结构可以推广
得到\textbf{本质代数结构}或者\textbf{广义代数结构}. 而类型论
的模型一般都可以写成这种形式, 进而可以运用代数结构的一般结论.

\section{族与丛, 分类空间}

我们先从集合出发, 描述一个一般的现象.
假如我希望描述一族集合, 最直接的方法就是给定一个指标集 \(B\),
然后对每个 \(b \in B\), 指定一个集合 \(E_b\).
换句话说就是有 \(E_\bullet : B \to \mathsf{Set}\).
但是另一方面, 我也可以将所有的 \(E_b\) 聚合起来
成为一个大集合 \(E\), 再用一个函数 \(p : E \to B\) 指出
每个元素所属的指标 \(b\) 是哪一个. 这两种描述方式是等价的.

\begin{center}
\begin{tikzpicture}
\draw (2,0) ellipse (0.9 and 0.6);
\node at (3.3,0) {\(B\)};
\node (C) at (2.4,-0.1) {\(\bullet\)};
\node (D) at (1.7,-0.3) {\(\bullet\)};
\node (E) at (1.9,0.25) {\(\bullet\)};

\draw (0.9,1.1) rectangle (1.6,2.9);
\node (Do) at (1.25, 2.3) {\(E_a\)};
\draw (1.6,1.1) rectangle (2.3,2.9);
\node (Eo) at (1.95, 1.7) {\(E_b\)};
\draw (2.3,1.1) rectangle (3,2.9);
\node (Co) at (2.65, 2) {\(E_c\)};
\draw (1.25,1.1) edge[->, out=-90] (D);
\draw (1.95,1.1) edge[->, out=-90, in=85] (E);
\draw (2.65,1.1) edge[->, out=-90, in=70] (C);
\end{tikzpicture}
\end{center}

事实上还有更加简单的例子. 考虑子集 \(E \subseteq B\).
它可以等价的描述为 \(B \to \{\cons{yes}, \cons{no}\}\),
因为只需要知道全集中的每个元素是否在这个子集里, 就完全确定了子集.
这是一种一般的现象, 即同一个概念可以描述为某种族 \(B \to U\),
也可以描述为某种丛 ------ 丛就是满足某条件的态射 \(p : E \to B\),
在子集的情况下就是单射 \(E \rightarrowtail B\),
而在集合族的情况下就是任何从集合到集合的映射.

下面的表格描述了数学中出现的许多族与丛的对应关系.
表格中画横线表示有这种构造, 但是没有通用的名字.
读者不必明白每个例子.

\begin{center}
\begin{tabular}{c c c c}\hline
族 & 族至丛 & 丛至族 & 丛\\\hline
\(\varphi : B \to \{\cons{yes}, \cons{no}\}\) &
\(E = \{b \in B \mid \varphi(b)\}\) &
\(\varphi(b) = (b \in E)\)&
子集 \(E \subseteq B\) \\
\(F : B \to \mathsf{Set}\) &
\!\!不交并 \(E = \coprod_{b} F(b)\)\!\! &
原象 \(F(b) = p^{-1}\{b\}\) &
\(p : E \to B\)\\
\(F : \mathcal C \to \mathsf{Set}\) &
元素范畴 \(\int^{\mathcal C}F\) &
原象 &
离散纤维化 \(\mathcal E \to \mathcal C\)\\
\!群同态 \(G \to \mathrm{Aut}(H)\)\!&
半直积 \(H \rtimes G\) &
------ &
分裂扩张 \(\hat G \to G\)\\
\(F : \mathcal C \to \mathsf{Cat}\) &
\!Grothendieck 构造\! &
原象 &
\!Grothendieck 纤维化\! \\
连续映射 \(B \to \mathbf{B}G\) &
------ &
分类映射 &
\(G\)-主丛 \(E \to B\)
\\\hline
\end{tabular}
\end{center}
\berry{2}

\(\{\cons{yes}\} \subseteq \{\cons{yes}, \cons{no}\}\)
可以看作是\textbf{万有}的子集, 因为对任何子集 \(E \subseteq B\),
以下交换方是拉回.
\[\begin{tikzcd}
  E & {\{\cons{yes}\}} \\
  B & {\{\cons{yes}, \cons{no}\}}
  \arrow[hook, from=1-1, to=2-1]
  \arrow[hook, from=1-2, to=2-2]
  \arrow[from=1-1, to=1-2]
  \arrow[from=2-1, to=2-2]
  \arrow["\lrcorner"{anchor=center, pos=0.125}, draw=none, from=1-1, to=2-2]
\end{tikzcd}\]
从这个角度看, 一切子集都源于
\(\{\cons{yes}\} \subseteq \{\cons{yes}, \cons{no}\}\),
或者说, 这个子集包含了一切其他子集可能出现的情况.
更严格来说, 有如下性质.
\begin{theorem}
对于集合 \(B\), 它的子集与映射 \(B \to \{\cons{yes}, \cons{no}\}\)
一一对应, 并且对应关系是上图的拉回关系.
\end{theorem}
因此, 我们说 \(\{\cons{yes}\} \subseteq \{\cons{yes}, \cons{no}\}\)
\textbf{分类}了全体子集.
这可以类推到集合族上.
考虑 \(\tilde{\mathsf{Set}}\) 为全体形如
\((A, a)\) 的有序对, 其中 \(a \in A\).%
\footnote{这里为了避免处理真类的问题, 可以不考虑全体集合.
例如可以固定一个较大的集合 \(U\), 只考虑这个集合的子集.}
有显然的映射 \(\tilde{\mathsf{Set}} \to \mathsf{Set}\),
将 \((A, a)\) 映射到 \(A\).
这样, 如果有集合族 \(E_\bullet : B \to \mathsf{Set}\),
那么也不难验证这是拉回.
\[\begin{tikzcd}
  E & {\tilde{\mathsf{Set}}} \\
  B & {\mathsf{Set}}
  \arrow[from=1-1, to=2-1]
  \arrow[from=1-2, to=2-2]
  \arrow[from=1-1, to=1-2]
  \arrow["{E_\bullet}"', from=2-1, to=2-2]
  \arrow["\lrcorner"{anchor=center, pos=0.125}, draw=none, from=1-1, to=2-2]
\end{tikzcd}\]
类似地可以说 \(\tilde{\mathsf{Set}} \to \mathsf{Set}\) 分类了全体集合族.

当然, 上面的说法有一些不严谨, 因为两个不同的 \(E_\bullet\)
可能给出同构的 \(E \to B\). 因为态射之间是直接比较相等,
而对象之间比较的是同构的概念, 这种情况难免出现.
子集能避免这个问题, 是因为两个子集之间至多有一种方法同构.
如果有 \(\tilde X \to X\), 使得在 \(E \to B\) 与某个
\(B \to X\) 之间有拉回的对应关系,
不过多个 \(B \to X\) 可能对应同构的 \(E \to B\),
就称 \(\tilde X \to X\) \textbf{弱分类}了 \(E \to B\) 的态射.

\section{类型论的自然模型}\label{category:naturalmodel}

历史上提出了很多描述类型论语义的方案. 为了使叙述更加清晰,
我们先介绍 Awodey 提出的自然模型~\cite{awodey:2018:natural},
再简单补充一些历史源流.
\cite{newstead:2018:natmod-poly} 也有较为详细的讲解.
\berry{3}

\begin{definition}\label{category:naturalmodeldef}
一个\textbf{自然模型}是任意一个有终对象的范畴 \(\mathcal C\),
配备两个预层与其间的态射 \(\pi : \mathrm{Tm} \to \mathrm{Tp}\),
使得对于任何 \(\Gamma \in \mathcal C\)
与 \(A \in \mathrm{Tp}(\Gamma) \cong \hom(\yo(\Gamma), \mathrm{Tp})\),
有对象表出以下拉回预层：
\[\begin{tikzcd}
\bullet & {\mathrm{Tm}} \\
{\yo(\Gamma)} & {\mathrm{Tp}}
\arrow["\pi", from=1-2, to=2-2]
\arrow["A"', from=2-1, to=2-2]
\arrow[from=1-1, to=2-1]
\arrow[from=1-1, to=1-2]
\arrow["\lrcorner"{anchor=center, pos=0.125}, draw=none, from=1-1, to=2-2]
\end{tikzcd}\]
此对象记作 \((\Gamma, A)\). 满足这种条件的态射也称作\textbf{可表态射}.
另外, 将态射 \((\Gamma, A) \to \Gamma\) 记作 \(\cons{p}_A\),
交换图上沿的态射记作 \(\cons{q}_A\).
\end{definition}

我们将语法构造成模型, 便可展示此定义的动机.
考虑所有合法语境在判值相等关系下构成的集合 \(\mathcal C\),
两个语境之间的态射 \(\sigma \in \hom(\Delta, \Gamma)\) 是代换,
即一列类型与 \(\Gamma\) 相符的表达式, 其中包含 \(\Delta\) 的变量.
判值相等的代换视为相同. 这样就构成一个范畴. 终对象是空语境.
对于每个语境 \(\Gamma\),
考虑允许包含 \(\Gamma\) 中的变量的合法的类型构成的集合 \(\mathrm{Tp}(\Gamma)\),
同样将判值相等的类型视为相同.
这些类型的元素的不交并记作 \(\mathrm{Tm}(\Gamma)\).
这样, 如果 \(\Gamma\) 下 \(A\) 是合法的类型,
又有代换 \(\sigma \in \hom(\Delta, \Gamma)\),
那么就可以将 \(A\) 中的变量代换得到 \(A[\sigma]\),
是 \(\Delta\) 下合法的类型.
这就证明了 \(\mathrm{Tp}\) 是预层. 同理 \(\mathrm{Tm}\) 也是预层.
\(\pi\) 将每个 \(a \in \mathrm{Tm}(\Gamma)\) 映射到它所属的类型.

我们来计算定义中提到的拉回. 我们知道预层的拉回是逐点计算的,
因此拉回 \(F\) 满足
\begin{align*}
F(\Delta)
&\cong \hom(\Delta, \Gamma) \times_{\mathrm{Tp}(\Delta)} \mathrm{Tm}(\Delta)\\
&= \{(\sigma, a) \mid \pi(a) = A[\sigma]\}\\
&= \hom(\Delta, (\Gamma, A)).
\end{align*}
因此 \(F\) 的确可表, 并且其表出对象就对应语境的扩展操作 \((\Gamma, A)\).
这里, \(\mathrm{Tm} \to \mathrm{Tp}\) 就分类了
形如 \((\Gamma,A) \to \Gamma\) 的态射.

以上就证明了类型论的语法范畴构成自然模型, 记作 \(\mathbf T\).%
\footnote{当然, 因为我们还没有引入任何类型, 语法范畴其实是平凡的.
但是上面的证明可以随着加入新的类型而随时拓展.}
以此为模板, 就可以找到类型论语法中许多概念的语义对应.
例如, 类型论中的语境对应自然模型中 \(\mathcal C\) 的对象,
语境之间的代换对应 \(\mathcal C\) 中的态射.
语境中的类型对应 \(\mathrm{Tp}(\Gamma)\) 的元素.
给定 \(A : \mathrm{Tp}(\Gamma)\),
类型论中 \(A\) 的元素对应模型中的
\[\{a \mid a \in \mathrm{Tm}(\Gamma), \pi(a) = A\}.\]
由拉回的性质, 可以看出这等价于
\[\{\alpha \mid \alpha \in \hom(\Gamma, (\Gamma, A)), \cons{p}_A \circ \alpha = \cons{id}_\Gamma\}.\]
对于 \(A : \mathrm{Tp}(\Gamma), \sigma : \Delta \to \Gamma\),
由于 \(\mathrm{Tp}\) 是预层, 我们可以得到 \(A[\sigma] : \mathrm{Tp}(\Delta)\).
这是类型论中代换的对应. 而由于下图中右侧的正方形与外侧的正方形均是拉回,
\[\begin{tikzcd}
  {\yo(\Delta, A[\sigma])} & {\yo(\Gamma,A)} & {\mathrm{Tm}} \\
  {\yo(\Delta)} & {\yo(\Gamma)} & {\mathrm{Tp}}
  \arrow[from=2-2, to=2-3]
  \arrow[from=1-3, to=2-3]
  \arrow[from=1-2, to=2-2]
  \arrow[from=1-2, to=1-3]
  \arrow[from=2-1, to=2-2]
  \arrow[from=1-1, to=2-1]
  \arrow[curve={height=-9pt}, from=1-1, to=1-3]
  \arrow[dashed, from=1-1, to=1-2]
\end{tikzcd}\]
我们得到虚线的箭头也存在, 使得整体构成交换图并且左侧的正方形是拉回.
因此在 \(\mathcal C\) 中有这样一个拉回.
\[\begin{tikzcd}
  {(\Delta, A[\sigma])} & {(\Gamma,A)} \\
  \Delta & \Gamma
  \arrow[from=1-2, to=2-2]
  \arrow[from=2-1, to=2-2]
  \arrow[from=1-1, to=2-1]
  \arrow[dashed, from=1-1, to=1-2]
\end{tikzcd}\]
在一些其他的类型论的模型的定义中,
不涉及预层范畴, 而是直接将这个拉回作为类型论中代换的定义.

如何说明自然模型的确是合适的概念呢?
模型最重要的作用, 是语法中的概念可以解释到所有模型中.
用范畴的语言来说, 对于任何模型 \(\mathbf M\),
都有唯一的保持结构的态射 \(\mathbf T \to \mathbf M\).
这一点可以靠对语法归纳来证明.
我们之后会定义带有 \(\Pi\)-类型的模型, 带有 \(\Sigma\)-类型的模型, 等等.
它们各自也有对应的性质：
考虑带有 \(\Pi\)-类型的类型论构成的语法模型,
它到任何带有 \(\Pi\)-类型的模型都有唯一的保持结构的态射,
以此类推.

上面还没有定义何为保持结构的态射.
以下为了方便, 对于模型 \(\mathbf M\),
记它对应的范畴为 \(\mathcal C_{\mathbf M}\),
配备的预层是 \(\mathrm{Tm}_{\mathbf M}, \mathrm{Tp}_{\mathbf M}\),
有可表态射 \(\pi_{\mathbf M}\).
假如有函子 \(F : \mathcal C \to \mathcal D\),
那么复合上这个函子, 就给出了预层范畴之间的映射
\(F^* : \mathsf{Psh}(\mathcal D) \to \mathsf{Psh}(\mathcal C)\).

\begin{definition}
给定两个自然模型 \(\mathbf M, \mathbf N\),
定义一个\textbf{态射} \(F : \mathbf M \to \mathbf N\) 为
一个函子 \(F : \mathcal C_{\mathbf M} \to \mathcal C_{\mathbf N}\),
两个态射 \(F_{\mathrm{Tp}} , F_{\mathrm{Tm}}\) 使得以下图表交换：
\[\begin{tikzcd}
  {\mathrm{Tm}_{\mathbf M}} & {F^*\mathrm{Tm}_{\mathbf N}} \\
  {\mathrm{Tp}_{\mathbf M}} & {F^*\mathrm{Tp}_{\mathbf N}}
  \arrow["{F_{\mathrm{Tp}}}"', from=2-1, to=2-2]
  \arrow["{F_{\mathrm{Tm}}}", from=1-1, to=1-2]
  \arrow["{\pi_{\mathbf M}}"', from=1-1, to=2-1]
  \arrow["{F^* \pi_{\mathbf N}}", from=1-2, to=2-2]
\end{tikzcd}\]
此时对于任何 \(\Gamma \in \mathcal C_{\mathbf M}\) 与
\(A \in \mathrm{Tp}_{\mathbf M}(\Gamma)\), 有
\(F(\Gamma) \in \mathcal C_{\mathbf N}\) 与
\(F_{\mathrm{Tp}}(A) \in \mathrm{Tp}_{\mathbf N}(F(\Gamma))\),
并且自然诱导一个态射 \(F(\Gamma, A) \to (F(\Gamma), F_{\mathrm{Tp}}(A))\).
我们要求这个态射是同构.
\end{definition}

其中, 最后这个条件是在要求自然模型之间的态射保持 \((-,-)\) 这个运算.
如果这不仅是同构, 而是直接严格相等, 就说\(F\)是自然模型之间的\textbf{严格态射}.

\subsection{自然模型中的类型}

自然模型仅仅是搭建起了类型论模型的基本框架.
接下来, 我们要为这个框架加入具体的类型.
先从最简单的单元素类型开始.

我们同样从语法范畴寻找启发. 对于有单元素类型的类型论,
在任何语境 \(\Gamma\) 下都有 \(\Gamma \vdash \cons{Unit}\,\text{type}\).
因此应当有预层的态射 \(1 \to \mathrm{Tp}\),
在 \(\mathrm{Tp}\) 中指出单位类型.
而单位类型在任何语境下都恰好有一个元素. 因此如果考虑拉回
\[\begin{tikzcd}
  \bullet & {\mathrm{Tm}} \\
  1 & {\mathrm{Tp}}
  \arrow[from=1-2, to=2-2]
  \arrow["{\cons{Unit}}"', from=2-1, to=2-2]
  \arrow[from=1-1, to=2-1]
  \arrow[from=1-1, to=1-2]
  \arrow["\lrcorner"{anchor=center, pos=0.125}, draw=none, from=1-1, to=2-2]
\end{tikzcd}\]
那么其左上角应当也是 \(1\).
\begin{definition}
给定自然模型,
如果有一个映射 \(\cons{Unit} : 1 \to \mathrm{Tp}\),
使得它与 \(\pi\) 拉回得到的也是终对象, 那么就称
\(\cons{Unit}\) 是该自然模型的\textbf{单位类型结构}.
\end{definition}
注意单位类型是\emph{结构}而不是\emph{性质},
也就是说同一个自然模型可能有两种不同的单位类型结构,
这是因为两个不同的单位类型可以仅仅是同构而不严格相等.

更复杂的类型也是相似的. 接下来考虑 \(\Pi\)-类型.
它的规则是
\[\frac{\Gamma \vdash A\,\text{type}
\quad\Gamma, x{:}A \vdash B\,\text{type}}
{\Gamma \vdash \prod_{x : A} B\,\text{type}}\]
因此我们需要考虑一个预层
\[F(\Gamma) = \{(A, B) \mid
  A \in \mathrm{Tp}(\Gamma), B \in \mathrm{Tp}(\Gamma, A)\}.\]
这个定义的自然性来自 \(\mathrm{Tp}\) 与 \((-,-)\) 的自然性.
与单位类型类似, 我们需要寻找预层的态射 \(\cons{Pi} : F \to \mathrm{Tp}\),
指出由 \(A, B\) 构成的 \(\Pi\)-类型.
\(\Pi\)-类型的元素, 可以通过 \(\Gamma, x{:}A \vdash b : B\) 构造.
因此考虑另一个预层
\[G(\Gamma) = \{(A, B, b) \mid b \in \mathrm{Tm}(\Gamma, A), \pi(b) = B\},\]
其中 \(A, B\) 取值范围与 \(F\) 中相同.
有自然变换 \(G \to F\). 至此, 我们应当希望有一个交换方
\[\begin{tikzcd}
  G & {\mathrm{Tm}} \\
  F & {\mathrm{Tp}}
  \arrow[from=1-1, to=2-1]
  \arrow["{\cons{Pi}}"', from=2-1, to=2-2]
  \arrow["\pi", from=1-2, to=2-2]
  \arrow[from=1-1, to=1-2]
\end{tikzcd}\]
这就编码了 \(\Pi\)-类型的引入规则, 即 \(\lambda\) 操作.
% 接下来需要考虑消去规则, 即函数求值操作.
% \[
% \frac{\Gamma \vdash f : \prod_{x:A} B
% \quad \Gamma \vdash a : A}{
% \Gamma \vdash f(a) : B[x/a]}
% \]
% 在模型中, 这对应一个元素 \(f : \mathrm{Tm}(\Gamma)\),
% 满足 \(\pi(f) = \cons{Pi}(A, B)\). 画成交换图是
% \[\begin{tikzcd}
%   {\yo(\Gamma)} \\
%   & G & {\mathrm{Tm}} \\
%   & F & {\mathrm{Tp}}
%   \arrow["\pi", from=2-3, to=3-3]
%   \arrow[from=2-2, to=3-2]
%   \arrow["{\cons{Pi}}"{description}, from=3-2, to=3-3]
%   \arrow[from=2-2, to=2-3]
%   \arrow["f"{description}, curve={height=-6pt}, from=1-1, to=2-3]
%   \arrow[curve={height=6pt}, from=1-1, to=3-2]
% \end{tikzcd}\]
% 这里左侧的映射指出了 \((A,B) \in F(\Gamma)\).
接下来, 我们要求这个交换方是拉回.
\begin{definition}
给定自然模型, 如果有一个映射 \(\cons{Pi} : F \to \mathrm{Tp}\),
使得它与 \(\pi\) 拉回得到的是 \(G \to F\), 那么就称
\(\cons{Pi}\) 是该自然模型的 \textbf{\(\Pi\)-类型结构}.
\end{definition}
这就同时得到了 \(\Pi\)-类型的消去规则 (即函数求值),
还有 \(\beta\) 与 \(\eta\) 等式.
更加详细的解释与证明, 可以参考 \cite[定理 8]{awodey:2018:natural}.
\(\Sigma\)-类型也可以类似操作.
\(F\) 不变, 定义预层
\[H(\Gamma) = \{(A, B, a, b) \mid
  a,b \in \mathrm{Tm}(\Gamma),
  \pi(a) = A,
  \pi(b) = B[a]\}\]
其中 \(B[a]\) 是将 \(a\) 看作对应的代换 \(\Gamma \to (\Gamma,A)\).
\begin{definition}
给定自然模型, 如果有一个映射 \(\cons{Sigma} : F \to \mathrm{Tp}\),
使得它与 \(\pi\) 拉回得到的是 \(H \to F\), 那么就称
\(\cons{Sigma}\) 是该自然模型的 \textbf{\(\Sigma\)-类型结构}.
\end{definition}

上村太一~\cite{uemura:2019:general} 提出了一种逻辑框架,
可以方便地叙述范畴语义而不必如上操作繁杂的预层.

(intensional identity type)

\subsection{范畴语义的历史}

\begin{itemize}
\item 1984 年, Seely~\cite{seely:1984:lccc}
首次具体写出了用丛表示依值类型, 拉回表示代换的思想.
这隐含了融贯问题, 稍后会介绍.
\item 1986 年, Cartmell~\cite{cartmell:1986:contextualcat}
提出了含集范畴 (category with attributes) 及有语境性的变体.
\item 1993 年, Bart Jacobs~\cite{jacobs:1993:comprehensioncat}
提出了概括范畴, 这统一了之前的诸多概念.
\item Curien~\cite{curien:1993:coherence} 与 Hofmann~\cite{hofmann:1995:lccccoh}
讨论了融贯问题, 并给出了解决方案.
\item 1995 年, Dybjer~\cite{dybjer:1995:internal}
为了在类型论内研究类型论, 提出了含族范畴 (category with families) 的概念.
\item 2014 年, Clairambault~\cite{clairambault:2014:biequivalence}
给出了融贯问题的完整答案, 这在 \cite{curien:2014:revisit} 中有总结.
\item 2015 年, 由 Voevodsky 的相关工作启发了
融贯问题的新解决方案~\cite{lumsdaine:2015:universes}, 这强调了宇宙的重要性.
\item 2018 年, 含族范畴被 Awodey~\cite{awodey:2018:natural} 和 Fiore 各自独立重新表述为自然模型.
\item 2019 年, 上村太一~\cite{uemura:2019:general}
提出了通用的框架, 给出了一大类类型论的语法与语义的关系.
\end{itemize}

\section{外延类型论与局部积闭范畴}

use this to lead up to the next, also explain what Seely did

\subsection{融贯问题}

\section{意象与内语言}\label{category:inner}

(less material)

list some concrete biequivalences

